name: CI - Build & Test
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, ops/**, fix/** ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20", cache: "npm" }
      - run: npm ci --legacy-peer-deps
      - run: npm run test -- --run
        env:
          CI: true
      - run: npm run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: dist/
          retention-days: 7

  test-backend-node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend-node/package-lock.json
      - name: Install backend-node deps
        working-directory: backend-node
        run: npm ci
      - name: Lint backend-node
        working-directory: backend-node
        run: npm run lint || echo "No lint script defined"
      - name: Test backend-node
        working-directory: backend-node
        run: npm test || echo "No test script defined"

  test-backend-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11", cache: "pip" }
      - name: Install backend-python deps
        working-directory: backend-python
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      - name: Lint backend-python
        working-directory: backend-python
        run: python -m py_compile *.py || echo "Linting done"
      - name: Test backend-python
        working-directory: backend-python
        run: pytest || echo "No tests found"
            - name: Cache
            }
  uses: actions/cache@v5.0.1
  with:
    # A list of files, directories, and wildcard patterns to cache and restore
    path: 
    # An explicit key for restoring and saving the cache
    key: 
    # An ordered multiline string listing the prefix-matched keys, that are used for restoring stale cache if no cache hit occurred for key. Note `cache-hit` returns false in this case.
    restore-keys: # optional
    # The chunk size used to split up large files during upload, in bytes
    upload-chunk-size: # optional
    # An optional boolean when enabled, allows windows runners to save or restore caches that can be restored or saved respectively on other platforms
    enableCrossOsArchive: # optional, default is false
    # Fail the workflow if cache entry is not found
    fail-on-cache-miss: # optional, default is false
    # Check if a cache entry exists for the given input(s) (key, restore-keys) without downloading the cache
    lookup-only: # optional, default is false
    # Run the post step to save the cache even if another step before fails
    save-always: # optional, default is false
          env:
  VITE_BIRDEYE_API_KEY: your-actual-key
