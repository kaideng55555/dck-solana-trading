name: Verify Deployment
on:
  workflow_dispatch:
    inputs:
      verify_endpoints:
        description: 'Verify API endpoints'
        required: false
        type: boolean
        default: true
      api_base:
        description: 'API base URL to verify'
        required: false
        type: string
        default: 'https://api.dcktoken.com'
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: verify-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build UI
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: dist/
          retention-days: 7
  
  verify-endpoints:
    runs-on: ubuntu-latest
    if: inputs.verify_endpoints == true || github.event_name == 'pull_request'
    steps:
      - name: Check API health
        run: |
          API_BASE="${{ inputs.api_base || 'https://api.dcktoken.com' }}"
          
          echo "ðŸ” Verifying endpoints at $API_BASE"
          
          # Node API health check
          echo "Checking Node API..."
          NODE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_BASE:3001/health" || echo "000")
          echo "Node API status: $NODE_STATUS"
          
          # Python API health check
          echo "Checking Python API..."
          PYTHON_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_BASE:8000/docs" || echo "000")
          echo "Python API status: $PYTHON_STATUS"
          
          # Check WebSocket endpoint
          echo "Checking WebSocket availability..."
          WS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_BASE:3001/ws/new-mints" || echo "000")
          echo "WebSocket status: $WS_STATUS"
          
          # Report results
          if [ "$NODE_STATUS" = "200" ] && [ "$PYTHON_STATUS" = "200" ]; then
            echo "âœ… All endpoints healthy"
            exit 0
          else
            echo "âš ï¸ Some endpoints not responding (may not be deployed yet)"
            exit 0  # Don't fail if API isn't deployed yet
          fi
  
  verify-backend-node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend-node/package-lock.json
      
      - name: Install backend-node deps
        working-directory: backend-node
        run: npm ci
      
      - name: Verify backend-node can start
        working-directory: backend-node
        run: |
          echo "QUICKNODE_HTTP=https://api.mainnet-beta.solana.com" > .env
          echo "QUICKNODE_WSS=wss://api.mainnet-beta.solana.com" >> .env
          echo "PORT=3001" >> .env
          timeout 10s node server.js || exit 0
  
  verify-backend-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend-python/requirements.txt
      
      - name: Install backend-python deps
        working-directory: backend-python
        run: |
          pip install -r requirements.txt
      
      - name: Verify backend-python can start
        working-directory: backend-python
        run: |
          timeout 10s python -c "from main import app; print('âœ… FastAPI app loads')" || exit 0
